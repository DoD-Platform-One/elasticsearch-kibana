kind: Pod
apiVersion: v1
metadata:
  name: "{{ .Release.Name }}-ui-test"
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": test-success
    "helm.sh/hook-weight": "20"
    sidecar.istio.io/inject: "false"
  labels:
    helm-test: enabled
    {{- include "minio.labels" . | nindent 4 }}
spec:
  initContainers:
  - name: copier
    image: registry.dso.mil/platform-one/big-bang/pipeline-templates/pipeline-templates/cypress/included:5.0.0
    command:
    - "/bin/bash"
    - "-c"
    - |

        ls -la /src/
        cp /src/cypress.json /dest/
        mkdir -p /dest/cypress/integration/
        cp /src/*.js /dest/cypress/integration/
        ls -la /dest/
        ls -la /dest/cypress/integration/
    volumeMounts:
    - name: cypress-tests
      mountPath: /src
    - name: workdir
      mountPath: /dest
  containers:
    - name: {{ .Release.Name }}-ui-test
      image: registry.dso.mil/platform-one/big-bang/pipeline-templates/pipeline-templates/cypress/included:5.0.0
      imagePullPolicy: {{ .Values.image.imagePullPolicy | quote }}
      workingDir: /e2e
      env:
        - name: HOST
          value: {{ .Values.service.port | quote }}
        - name: MINIO_HOST
          value: {{ include "minio.serviceName" . }}
        - name: cypress_secretkey
          valueFrom:
            secretKeyRef:
              name: {{ .Values.minioRootCreds }}
              key: secretkey
        - name: cypress_accesskey
          valueFrom:
            secretKeyRef:
              name: {{ .Values.minioRootCreds }}
              key: accesskey
        - name: cypress_url
          value: "http://{{ .Release.Name }}-kb-http:5601"
      args:
      - "--"
      - "--reporter-options=list"
      - "--reporter=spec"
      volumeMounts:
      - name: workdir
        mountPath: /e2e/
  restartPolicy: Never
  volumes:
  - name: cypress-tests
    configMap:
      name: "{{ .Release.Name }}-cypress-test-configmap"
  - name: workdir
    emptyDir: {}
