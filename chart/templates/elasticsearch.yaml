apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
  name: {{ .Release.Name }}
  namespace: {{ .Release.Namespace }}
spec:
  version: {{ .Values.elasticsearch.version }}
  image: {{ .Values.elasticsearch.image.repository }}:{{ .Values.elasticsearch.image.tag }}

  {{- if .Values.sso.enabled }}
  secureSettings:
    - secretName: sso-secret
  {{- end }}

  nodeSets:

  #
  # Masters
  #
  {{- with .Values.elasticsearch.master }}
  - name: master
    count: {{ .count }}

    config:
      index.store.type: mmapfs
      node.data: false
      node.ingest: false
      node.master: true
      node.ml: false
      node.store.allow_mmap: true
      xpack.ml.enabled: false
      xpack.security.authc.token.enabled: true
      {{- with $.Values.sso }}
      {{- if .enabled }}
      xpack.security.authc.realms.oidc.{{ .oidc.realm }}:
        order: 2
        rp.client_id: {{ .client_id }}
        rp.response_type: code
        rp.redirect_uri: "https://{{ template "redirect_url" $ }}/api/security/oidc/callback"
        rp.signature_algorithm: RS256
        rp.requested_scopes:
          - openid
        op.authorization_endpoint: "https://{{ .oidc.host }}/auth/realms/{{ .oidc.realm }}/protocol/openid-connect/auth"
        op.token_endpoint: "https://{{ .oidc.host }}/auth/realms/{{ .oidc.realm }}/protocol/openid-connect/token"
        op.jwkset_path: "https://{{ .oidc.host }}/auth/realms/{{ .oidc.realm }}/protocol/openid-connect/certs"
        op.userinfo_endpoint: "https://{{ .oidc.host }}/auth/realms/{{ .oidc.realm }}/protocol/openid-connect/userinfo"
        op.endsession_endpoint: "https://{{ .oidc.host }}/auth/realms/{{ .oidc.realm }}/protocol/openid-connect/logout"
        op.issuer: "https://{{ .oidc.host }}/auth/realms/{{ .oidc.realm }}"
        rp.post_logout_redirect_uri: "https://{{ template "redirect_url" $ }}/logged_out"
        claims.principal: preferred_username
        claims.groups: groups
        claims.mail: email
      {{- end }}
      {{- end }}
    volumeClaimTemplates:
      - metadata:
          name: elasticsearch-data
        spec:
          resources:
            requests:
              storage: {{ .persistence.size }}
          accessModes:
            - ReadWriteOnce
          {{- if .persistence.storageClassName }}
          storageClassName: {{ .persistence.storageClassName }}
          {{- end }}

    podTemplate:
      metadata:
        annotations:
          fluentbit.io/exclude-istio-proxy: "true"
          prometheus.istio.io/merge-metrics: "false"
          sidecar.istio.io/rewriteAppHTTPProbers: "true"
          traffic.sidecar.istio.io/excludeInboundPorts: "9300"
          traffic.sidecar.istio.io/excludeOutboundPorts: "9300"
      spec:
        {{- if .securityContext }}
        securityContext:
        {{- toYaml .securityContext | nindent 10 }}
        {{- end }}

        {{- if .nodeSelector }}
        nodeSelector:
          {{ toYaml .nodeSelector | nindent 10 }}
        {{- end }}
        {{- if .affinity }}
        affinity:
          {{ toYaml .affinity | nindent 10 }}
        {{- end }}

        {{- if .initContainers }}
        initContainers:
        {{ toYaml .initContainers | nindent 10 }}
        {{- end }}
        containers:
          - name: elasticsearch
            env:
              - name: ES_JAVA_OPTS
                value: "-Xms{{ .heap.min }} -Xmx{{ .heap.max }}"
            resources:
              {{- toYaml .resources | nindent 14 }}
        {{- with $.Values.elasticsearch.imagePullSecrets }}
        imagePullSecrets:
        {{- toYaml . | nindent 10 }}
        {{- end }}

        {{- if $.Values.istio.enabled }}
        automountServiceAccountToken: true
      {{- end }}
  {{- end }}

  #
  # Data Nodes
  #
  {{- with .Values.elasticsearch.data }}
  - name: data
    count: {{ .count }}

    config:
      index.store.type: mmapfs
      node.data: true
      node.ingest: true
      node.master: false
      node.ml: false
      node.store.allow_mmap: true
      xpack.ml.enabled: false
      xpack.security.authc.token.enabled: true
      {{- with $.Values.sso }}
      {{- if .enabled }}
      xpack.security.authc.realms.oidc.{{ .oidc.realm }}:
        order: 2
        rp.client_id: {{ .client_id }}
        rp.response_type: code
        rp.redirect_uri: "https://{{ template "redirect_url" $ }}/api/security/oidc/callback"
        rp.signature_algorithm: RS256
        rp.requested_scopes:
          - openid
        op.authorization_endpoint: "https://{{ .oidc.host }}/auth/realms/{{ .oidc.realm }}/protocol/openid-connect/auth"
        op.token_endpoint: "https://{{ .oidc.host }}/auth/realms/{{ .oidc.realm }}/protocol/openid-connect/token"
        op.jwkset_path: "https://{{ .oidc.host }}/auth/realms/{{ .oidc.realm }}/protocol/openid-connect/certs"
        op.userinfo_endpoint: "https://{{ .oidc.host }}/auth/realms/{{ .oidc.realm }}/protocol/openid-connect/userinfo"
        op.endsession_endpoint: "https://{{ .oidc.host }}/auth/realms/{{ .oidc.realm }}/protocol/openid-connect/logout"
        op.issuer: "https://{{ .oidc.host }}/auth/realms/{{ .oidc.realm }}"
        rp.post_logout_redirect_uri: "https://{{ template "redirect_url" $ }}/logged_out"
        claims.principal: preferred_username
        claims.groups: groups
        claims.mail: email
      {{- end }}
      {{- end }}

    volumeClaimTemplates:
    - metadata:
        name: elasticsearch-data
      spec:
        resources:
          requests:
            storage: {{ .persistence.size }}
        accessModes:
        - ReadWriteOnce
        {{- if .persistence.storageClassName }}
        storageClassName: {{ .persistence.storageClassName }}
        {{- end }}

    podTemplate:
      metadata:
        annotations:
          fluentbit.io/exclude-istio-proxy: "true"
          prometheus.istio.io/merge-metrics: "false"
          sidecar.istio.io/rewriteAppHTTPProbers: "true"
          traffic.sidecar.istio.io/excludeInboundPorts: "9300"
          traffic.sidecar.istio.io/excludeOutboundPorts: "9300"

      spec:
        {{- if .securityContext }}
        securityContext:
        {{- toYaml .securityContext | nindent 10 }}
        {{- end }}

        {{- if .nodeSelector }}
        nodeSelector:
          {{ toYaml .nodeSelector | nindent 10 }}
        {{- end }}
        {{- if .affinity }}
        affinity:
          {{ toYaml .affinity | nindent 10 }}
        {{- end }}

        {{- if .initContainers }}
        initContainers:
        {{ toYaml .initContainers | nindent 10 }}
        {{- end }}
        containers:
          - name: elasticsearch
            env:
              - name: ES_JAVA_OPTS
                value: "-Xms{{ .heap.min }} -Xmx{{ .heap.max }}"
            resources:
              {{- toYaml .resources | nindent 14 }}
        {{- with $.Values.elasticsearch.imagePullSecrets }}
        imagePullSecrets:
          {{- toYaml . | nindent 10 }}
        {{- end }}

      {{- if $.Values.istio.enabled }}
        automountServiceAccountToken: true
      {{- end }}
  {{- end }}
