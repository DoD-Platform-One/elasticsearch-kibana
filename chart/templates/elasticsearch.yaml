apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
  name: {{ .Release.Name }}
  namespace: {{ .Release.Namespace }}
spec:
  version: {{ .Values.elasticsearch.version }}
  image: {{ .Values.elasticsearch.image.repository }}:{{ .Values.elasticsearch.image.tag }}

  {{- if .Values.sso.enabled }}
  secureSettings:
    - secretName: sso-secret
  {{- end }}

  nodeSets:

  #
  # Masters
  #
  {{- with .Values.elasticsearch.master }}
  - name: master
    count: {{ .count }}

    config:
      index.store.type: mmapfs
      node.data: false
      node.ingest: false
      node.master: true
      node.ml: false
      node.store.allow_mmap: true
      xpack.ml.enabled: false
      xpack.security.authc.token.enabled: true
      {{- if $.Values.sso.enabled }}
      {{ include "oidc" $ | indent 6 }}
      {{- end }}
    volumeClaimTemplates:
      - metadata:
          name: elasticsearch-data
        spec:
          resources:
            requests:
              storage: {{ .persistence.size }}
          accessModes:
            - ReadWriteOnce
          {{- if .persistence.storageClassName }}
          storageClassName: {{ .persistence.storageClassName }}
          {{- end }}

    podTemplate:
      metadata:
        annotations:
          prometheus.istio.io/merge-metrics: "false"
          sidecar.istio.io/rewriteAppHTTPProbers: "true"
          traffic.sidecar.istio.io/includeInboundPorts: "*"
          traffic.sidecar.istio.io/excludeInboundPorts: "9300"
          traffic.sidecar.istio.io/excludeOutboundPorts: "9300"
          sso-secret/checksum: {{ include (print $.Template.BasePath "/bigbang/sso-secret.yaml") $ | sha256sum }}
          values/checksum: {{ include "oidc" $ | sha256sum }}

      spec:
        {{- if .securityContext }}
        securityContext:
        {{- toYaml .securityContext | nindent 10 }}
        {{- end }}

        {{- if .nodeSelector }}
        nodeSelector:
          {{ toYaml .nodeSelector | nindent 10 }}
        {{- end }}
        {{- if .affinity }}
        affinity:
          {{ toYaml .affinity | nindent 10 }}
        {{- end }}

        {{- if .initContainers }}
        initContainers:
        {{ toYaml .initContainers | nindent 10 }}
        {{- end }}
        containers:
          - name: elasticsearch
            env:
              - name: ES_JAVA_OPTS
                value: "-Xms{{ .heap.min }} -Xmx{{ .heap.max }}"
            resources:
              {{- toYaml .resources | nindent 14 }}
            lifecycle:
              {{- toYaml .lifecycle | nindent 14 }}
        {{- with $.Values.elasticsearch.imagePullSecrets }}
        imagePullSecrets:
        {{- toYaml . | nindent 10 }}
        {{- end }}

        {{- if $.Values.istio.enabled }}
        automountServiceAccountToken: true
      {{- end }}
  {{- end }}

  #
  # Data Nodes
  #
  {{- with .Values.elasticsearch.data }}
  - name: data
    count: {{ .count }}

    config:
      index.store.type: mmapfs
      node.data: true
      node.ingest: true
      node.master: false
      node.ml: false
      node.store.allow_mmap: true
      xpack.ml.enabled: false
      xpack.security.authc.token.enabled: true
      {{- if $.Values.sso.enabled }}
      {{ include "oidc" $ | indent 6 }}
      {{- end }}

    volumeClaimTemplates:
    - metadata:
        name: elasticsearch-data
      spec:
        resources:
          requests:
            storage: {{ .persistence.size }}
        accessModes:
        - ReadWriteOnce
        {{- if .persistence.storageClassName }}
        storageClassName: {{ .persistence.storageClassName }}
        {{- end }}

    podTemplate:
      metadata:
        annotations:
          prometheus.istio.io/merge-metrics: "false"
          sidecar.istio.io/rewriteAppHTTPProbers: "true"
          traffic.sidecar.istio.io/includeInboundPorts: "*"
          traffic.sidecar.istio.io/excludeInboundPorts: "9300"
          traffic.sidecar.istio.io/excludeOutboundPorts: "9300"
          sso-secret/checksum: {{ include (print $.Template.BasePath "/bigbang/sso-secret.yaml") $ | sha256sum }}
          values/checksum: {{ include "oidc" $ | sha256sum }}
      spec:
        {{- if .securityContext }}
        securityContext:
        {{- toYaml .securityContext | nindent 10 }}
        {{- end }}

        {{- if .nodeSelector }}
        nodeSelector:
          {{ toYaml .nodeSelector | nindent 10 }}
        {{- end }}
        {{- if .affinity }}
        affinity:
          {{ toYaml .affinity | nindent 10 }}
        {{- end }}

        {{- if .initContainers }}
        initContainers:
        {{ toYaml .initContainers | nindent 10 }}
        {{- end }}
        containers:
          - name: elasticsearch
            env:
              - name: ES_JAVA_OPTS
                value: "-Xms{{ .heap.min }} -Xmx{{ .heap.max }}"
            resources:
              {{- toYaml .resources | nindent 14 }}
            lifecycle:
              {{- toYaml .lifecycle | nindent 14 }}
        {{- with $.Values.elasticsearch.imagePullSecrets }}
        imagePullSecrets:
          {{- toYaml . | nindent 10 }}
        {{- end }}

      {{- if $.Values.istio.enabled }}
        automountServiceAccountToken: true
      {{- end }}
  {{- end }}
