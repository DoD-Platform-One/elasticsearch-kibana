# -- Domain used for BigBang created exposed services.
hostname: bigbang.dev

autoRollingUpgrade:
  # -- Enable BigBang specific autoRollingUpgrade support
  enabled: true

# -- Pull Policy for all non-init containers in this package.
imagePullPolicy: IfNotPresent

kibana:
  # -- Kibana version
  version: 7.17.1
  image:
    # -- Kibana image repository
    repository: registry1.dso.mil/ironbank/elastic/kibana/kibana
    # -- Kibana image tag
    tag: 7.17.1

  # -- Kibana Ingress Host Value.
  # Only required if not using Istio for ingress.
  host: ""

  # -- Number of Kibana replicas
  count: 3

  # -- Name for serviceAccount to use, will be autocreated.
  serviceAccountName: "logging-kibana"

  # -- Kibana updateStrategy
  updateStrategy:
    type: rollingUpdate
    rollingUpdate:
      maxUnavailable: 1

  # -- Set securityContext for Kibana pods
  securityContext:
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000

  # -- Kibana imagePullSecrets
  imagePullSecrets: []

  # -- Kibana resources
  resources:
    requests:
      cpu: 1
      memory: 2Gi
    limits:
      cpu: 1
      memory: 2Gi

  # -- Kibana volumes
  volumes: []

  # -- Kibana volumeMounts
  volumeMounts: []

  # -- Kibana podAnnotations
  podAnnotations:
    {}
    # bigbang.dev/istioVersion: 1.10.3

  # -- Kibana affinity
  affinity:
    {}
    # podAntiAffinity:
    #   requiredDuringSchedulingIgnoredDuringExecution:
    #     - topologyKey: "kubernetes.io/hostname"
    #       labelSelector:
    #         matchLabels:
    #           dont-schedule-with: kibana
    # nodeAffinity:
    #   requiredDuringSchedulingIgnoredDuringExecution:
    #     nodeSelectorTerms:
    #     - matchExpressions:
    #       - key: node-type
    #         operator: In
    #         values:
    #         - "kibana"

  # -- Kibana tolerations
  tolerations:
    []
    # - key: "workload"
    #   operator: "Equal"
    #   value: "kibana"
    #   effect: "NoSchedule"

  # -- Kibana nodeSelector
  nodeSelector:
    {}
    # node-type: kibana

  # -- Kibana lifecycle
  lifecycle:
    {}
    # preStop:
    #   exec:
    #     command: ["/bin/sh", "-c", "echo Hello from the postStart handler > /usr/share/message"]
    # postStart:
    #   exec:
    #     command: ["/bin/sh", "-c", "echo Hello from the postStart handler > /usr/share/message"]

elasticsearch:
  # -- Elasticsearch version
  version: 7.17.1
  image:
    # -- Elasticsearch image repository
    repository: registry1.dso.mil/ironbank/elastic/elasticsearch/elasticsearch
    # -- Elasticsearch image tag
    tag: 7.17.1

  # -- Elasticsearch imagePullSecrets
  imagePullSecrets: []
  # -- Name for serviceAccount to use, will be autocreated.
  serviceAccountName: "logging-elasticsearch"

  # Values for Elasticsearch master node sets.
  master:
    # -- Add an init container that adjusts the kernel setting for elastic.
    initContainers: []
    #
    # NB:  This creates a privileged init container and runs a non-ironbank image.
    # It is safer to adjust the AMI for the nodes to include this kernel setting.
    # - name: sysctl
    #   securityContext:
    #     privileged: true
    #   image: busybox
    #   command: ['sh', '-c', 'sysctl -w vm.max_map_count=262144']

    # -- Set securityContext for elasticsearch master node sets
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000

    # -- Elasticsearch master updateStrategy
    updateStrategy:
      type: rollingUpdate
      rollingUpdate:
        maxUnavailable: 1

    # -- Elasticsearch master volumes
    volumes: []
    # - name: cert
    #   secret:
    #     secretName: cert
    #     defaultMode: 0644

    # -- Elasticsearch master volumeMounts
    volumeMounts: []
    # - mountPath: "/usr/share/elasticsearch/config/oidc/ca.crt"
    #   name: cert
    #   subPath: ca.crt
    #   readOnly: true

    # -- Elasticsearch master podAnnotations
    podAnnotations:
      {}
      # bigbang.dev/istioVersion: 1.10.3

    # -- Elasticsearch master affinity
    affinity:
      {}
      # podAntiAffinity:
      #   requiredDuringSchedulingIgnoredDuringExecution:
      #     - topologyKey: "kubernetes.io/hostname"
      #       labelSelector:
      #         matchLabels:
      #           dont-schedule-with: elastic-master
      # nodeAffinity:
      #   requiredDuringSchedulingIgnoredDuringExecution:
      #     nodeSelectorTerms:
      #     - matchExpressions:
      #       - key: node-type
      #         operator: In
      #         values:
      #         - "elastic-master"

    # -- Elasticsearch master tolerations
    tolerations:
      []
      # - key: "workload"
      #   operator: "Equal"
      #   value: "elasticsearch"
      #   effect: "NoSchedule"

    # -- Elasticsearch master nodeSelector
    nodeSelector:
      {}
      # node-type: elastic-master

    # -- Elasticsearch master lifecycle
    lifecycle:
      {}
      # preStop:
      #   exec:
      #     command: ["/bin/sh", "-c", "echo Hello from the postStart handler > /usr/share/message"]

    # -- Elasticsearch master pod count
    count: 3
    persistence:
      # -- Elasticsearch master persistence storageClassName
      storageClassName: ""
      # -- Elasticsearch master persistence size
      size: 5Gi
    # -- Elasticsearch master pod resources
    resources:
      limits:
        cpu: 1
        memory: 4Gi
      requests:
        cpu: 1
        memory: 4Gi
    heap:
      # -- Elasticsearch master Java heap Xms setting
      min: 2g
      # -- Elasticsearch master Java heap Xmx setting
      max: 2g

  # Values for Elasticsearch data node sets.
  data:
    # -- Add an init container that adjusts the kernel setting for elastic.
    initContainers: []
    # NB:  This creates a privileged init container and runs a non-ironbank image.
    # It is safer to adjust the AMI for the nodes to include this kernel setting.
    # - name: sysctl
    #   securityContext:
    #     privileged: true
    #   image: busybox
    #   command: ['sh', '-c', 'sysctl -w vm.max_map_count=262144']

    # -- Set securityContext for elasticsearch data node sets
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000

    # -- Elasticsearch data volumes
    volumes:
      []
      # - name: cert
      #   secret:
      #     secretName: cert
      #     defaultMode: 0644

    # -- Elasticsearch data volumeMounts
    volumeMounts:
      []
      # - mountPath: "/usr/share/elasticsearch/config/oidc/ca.crt"
      #   name: cert
      #   subPath: ca.crt
      #   readOnly: true

    # -- Elasticsearch data podAnnotations
    podAnnotations:
      {}
      # bigbang.dev/istioVersion: 1.10.3

    # -- Elasticsearch data affinity
    affinity:
      {}
      # podAntiAffinity:
      #   requiredDuringSchedulingIgnoredDuringExecution:
      #     - topologyKey: "kubernetes.io/hostname"
      #       labelSelector:
      #         matchLabels:
      #           dont-schedule-with: elastic-data
      # nodeAffinity:
      #   requiredDuringSchedulingIgnoredDuringExecution:
      #     nodeSelectorTerms:
      #     - matchExpressions:
      #       - key: node-type
      #         operator: In
      #         values:
      #         - "elastic-data"

    # -- Elasticsearch data tolerations
    tolerations:
      []
      # - key: "workload"
      #   operator: "Equal"
      #   value: "elastic-data"
      #   effect: "NoSchedule"

    # -- Elasticsearch data nodeSelector
    nodeSelector:
      {}
      # node-type: elastic-data

    # -- Elasticsearch data lifecycle
    lifecycle:
      {}
      # preStop:
      #   exec:
      #     command: ["/bin/sh", "-c", "echo Hello from the postStart handler > /usr/share/message"]

    # -- Elasticsearch data pod count
    count: 4
    persistence:
      # -- Elasticsearch data persistence storageClassName
      storageClassName: ""
      # -- Elasticsearch data persistence size
      size: 100Gi
    # -- Elasticsearch data pod resources
    resources:
      limits:
        cpu: 1
        memory: 4Gi
      requests:
        cpu: 1
        memory: 4Gi
    heap:
      # -- Elasticsearch data Java heap Xms setting
      min: 2g
      # -- Elasticsearch data Java heap Xmx setting
      max: 2g

  #
  # Ingest
  #
  # Values for Elasticsearch ingest node sets.
  ingest:
    # -- Enable ingest specific Elasticsearch pods
    enabled: false
    # -- initContainers
    initContainers: []
    # add an init container that adjusts the kernel setting for elastic
    # - name: sysctl
    #   securityContext:
    #     privileged: true
    #   image: busybox
    #   command: ['sh', '-c', 'sysctl -w vm.max_map_count=262144']

    # -- Set securityContext for elasticsearch ingest node sets
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000

    # -- volumes
    volumes:
      []
      # - name: cert
      #   secret:
      #     secretName: cert
      #     defaultMode: 0644

    # -- volumeMounts
    volumeMounts:
      []
      # - mountPath: "/usr/share/elasticsearch/config/oidc/ca.crt"
      #   name: cert
      #   subPath: ca.crt
      #   readOnly: true

    # -- podAnnotations
    podAnnotations:
      {}
      # bigbang.dev/istioVersion: 1.10.3

    # -- affinity
    affinity:
      {}
      # podAntiAffinity:
      #   requiredDuringSchedulingIgnoredDuringExecution:
      #     - topologyKey: "kubernetes.io/hostname"
      #       labelSelector:
      #         matchLabels:
      #           dont-schedule-with: elastic-data
      # nodeAffinity:
      #   requiredDuringSchedulingIgnoredDuringExecution:
      #     nodeSelectorTerms:
      #     - matchExpressions:
      #       - key: node-type
      #         operator: In
      #         values:
      #         - "elastic-data"

    # -- tolerations
    tolerations:
      []
      # - key: "workload"
      #   operator: "Equal"
      #   value: "elastic-data"
      #   effect: "NoSchedule"

    # -- nodeSelector
    nodeSelector:
      {}
      # node-type: elastic-data

    # -- lifecycle
    lifecycle:
      {}
      # preStop:
      #   exec:
      #     command: ["/bin/sh", "-c", "echo Hello from the postStart handler > /usr/share/message"]

    # -- count
    count: 1
    persistence:
      # -- storageClassName
      storageClassName: ""
      # -- size
      size: 100Gi
    # -- Elasticsearch ingest pod resources
    resources:
      limits:
        cpu: 1
        memory: 4Gi
      requests:
        cpu: 1
        memory: 4Gi
    heap:
      # -- Xms
      min: 2g
      # -- Xmx
      max: 2g

  #
  # ML
  #
  # Values for Elasticsearch ML node sets.
  ml:
    # -- Enable Machine Learning specific Elasticsearch pods
    enabled: false
    # -- initContainers
    initContainers: []
    # add an init container that adjusts the kernel setting for elastic
    # - name: sysctl
    #   securityContext:
    #     privileged: true
    #   image: busybox
    #   command: ['sh', '-c', 'sysctl -w vm.max_map_count=262144']

    # -- Set securityContext for elasticsearch ml node sets
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000

    # -- Elasticsearch ml updateStrategy
    updateStrategy:
      type: rollingUpdate
      rollingUpdate:
        maxUnavailable: 1

    # -- volumes
    volumes:
      []
      # - name: cert
      #   secret:
      #     secretName: cert
      #     defaultMode: 0644

    # -- volumeMounts
    volumeMounts:
      []
      # - mountPath: "/usr/share/elasticsearch/config/oidc/ca.crt"
      #   name: cert
      #   subPath: ca.crt
      #   readOnly: true

    # -- podAnnotations
    podAnnotations:
      {}
      # bigbang.dev/istioVersion: 1.10.3

    # -- affinity
    affinity:
      {}
      # podAntiAffinity:
      #   requiredDuringSchedulingIgnoredDuringExecution:
      #     - topologyKey: "kubernetes.io/hostname"
      #       labelSelector:
      #         matchLabels:
      #           dont-schedule-with: elastic-data
      # nodeAffinity:
      #   requiredDuringSchedulingIgnoredDuringExecution:
      #     nodeSelectorTerms:
      #     - matchExpressions:
      #       - key: node-type
      #         operator: In
      #         values:
      #         - "elastic-data"

    # -- tolerations
    tolerations:
      []
      # - key: "workload"
      #   operator: "Equal"
      #   value: "elastic-ml"
      #   effect: "NoSchedule"

    # -- nodeSelector
    nodeSelector:
      {}
      # node-type: elastic-data

    # -- lifecycle
    lifecycle:
      {}
      # preStop:
      #   exec:
      #     command: ["/bin/sh", "-c", "echo Hello from the postStart handler > /usr/share/message"]

    # -- count
    count: 1
    persistence:
      # -- storageClassName
      storageClassName: ""
      # -- size
      size: 100Gi
    # -- Elasticsearch ml pod resources
    resources:
      limits:
        cpu: 1
        memory: 4Gi
      requests:
        cpu: 1
        memory: 4Gi
    heap:
      # --Xms
      min: 2g
      # -- Xmx
      max: 2g

  #
  # Coordinating
  #
  # Values for Elasticsearch coordinating node sets.
  coord:
    # -- Enable coordinating specific Elasticsearch pods
    enabled: false
    # -- initContainers
    initContainers: []
    # add an init container that adjusts the kernel setting for elastic
    # - name: sysctl
    #   securityContext:
    #     privileged: true
    #   image: busybox
    #   command: ['sh', '-c', 'sysctl -w vm.max_map_count=262144']

    # -- Set securityContext for elasticsearch coordinating node sets
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000

    # -- Elasticsearch coord updateStrategy
    updateStrategy:
      type: rollingUpdate
      rollingUpdate:
        maxUnavailable: 1

    # -- volumes
    volumes:
      []
      # - name: cert
      #   secret:
      #     secretName: cert
      #     defaultMode: 0644

    # -- volumeMounts
    volumeMounts:
      []
      # - mountPath: "/usr/share/elasticsearch/config/oidc/ca.crt"
      #   name: cert
      #   subPath: ca.crt
      #   readOnly: true

    # -- podAnnotations
    podAnnotations:
      {}
      # bigbang.dev/istioVersion: 1.10.3

    # -- affinity
    affinity:
      {}
      # podAntiAffinity:
      #   requiredDuringSchedulingIgnoredDuringExecution:
      #     - topologyKey: "kubernetes.io/hostname"
      #       labelSelector:
      #         matchLabels:
      #           dont-schedule-with: elastic-data
      # nodeAffinity:
      #   requiredDuringSchedulingIgnoredDuringExecution:
      #     nodeSelectorTerms:
      #     - matchExpressions:
      #       - key: node-type
      #         operator: In
      #         values:
      #         - "elastic-data"

    # -- tolerations
    tolerations: []
    # - key: "workload"
    #   operator: "Equal"
    #   value: "elastic-coord"
    #   effect: "NoSchedule"

    # -- nodeSelector
    nodeSelector:
      {}
      # node-type: elastic-data

    # -- lifecycle
    lifecycle:
      {}
      # preStop:
      #   exec:
      #     command: ["/bin/sh", "-c", "echo Hello from the postStart handler > /usr/share/message"]

    # -- count
    count: 1
    persistence:
      # -- storageClassName
      storageClassName: ""
      # -- size
      size: 100Gi
    # -- Elasticsearch coord pod resources
    resources:
      limits:
        cpu: 1
        memory: 4Gi
      requests:
        cpu: 1
        memory: 4Gi
    heap:
      # -- Xms
      min: 2g
      # -- Xmx
      max: 2g

istio:
  # -- Toggle istio interaction.
  enabled: false
  kibana:
    # -- Toggle virtualService creation
    enabled: true
    # -- Annotations for controls the gateway used/attached to the virtualService
    annotations: {}
    # -- Labels for virtualService
    labels: {}
    # -- Gateway(s) to apply virtualService routes to.
    gateways:
      - istio-system/main
    # -- hosts for the virtualService
    hosts:
      - kibana.{{ .Values.hostname }}

sso:
  # -- Toggle SSO with Keycloak
  enabled: false
  # -- redirect_url defaults to .Values.istio.kibana.hosts[0] if not set.
  redirect_url: ""
  # -- client_id
  client_id: platform1_a8604cc9-f5e9-4656-802d-d05624370245_bb8-kibana

  # -- OIDC client secret, can be empty for public client.
  client_secret: ""
  oidc:
    # -- host
    host: login.dso.mil
    # -- realm
    realm: baby-yoda

  # Additional fields (required for SSO - default templates for keycloak)

  # -- issuer
  issuer: "https://{{ .Values.sso.oidc.host }}/auth/realms/{{ .Values.sso.oidc.realm }}"
  # -- auth_url
  auth_url: "https://{{ .Values.sso.oidc.host }}/auth/realms/{{ .Values.sso.oidc.realm }}/protocol/openid-connect/auth"
  # -- token_url
  token_url: "https://{{ .Values.sso.oidc.host }}/auth/realms/{{ .Values.sso.oidc.realm }}/protocol/openid-connect/token"
  # -- userinfo_url
  userinfo_url: "https://{{ .Values.sso.oidc.host }}/auth/realms/{{ .Values.sso.oidc.realm }}/protocol/openid-connect/userinfo"
  # -- jwks_url
  jwkset_url: "https://{{ .Values.sso.oidc.host }}/auth/realms/{{ .Values.sso.oidc.realm }}/protocol/openid-connect/certs"
  # -- claims_principal
  claims_principal: "preferred_username"
  # -- requested_scopes
  requested_scopes:
    - openid

  # Additional fields (required for keycloak - may be optional for other providers).

  # -- signature_algorithm
  signature_algorithm: "RS256"
  # --endsession_url
  endsession_url: "https://{{ .Values.sso.oidc.host }}/auth/realms/{{ .Values.sso.oidc.realm }}/protocol/openid-connect/logout"
  # -- claims_group
  claims_group: "groups"
  # -- claims_mail
  claims_mail: "email"

  # Additional fields.

  # -- claims_principal_pattern
  claims_principal_pattern: ""
  # -- cert_authorities
  cert_authorities: []

kibanaBasicAuth:
  # -- Toggle this to turn off Kibana's built in auth and only allow SSO. Role mappings for SSO groups must be set up and SSO enabled before doing this.
  enabled: true

networkPolicies:
  # -- Toggle BigBang NetworkPolicy templates
  enabled: false
  # -- Istio Ingressgateway labels.
  # passed down to NetworkPolicy to whitelist external access to app
  ingressLabels:
    app: istio-ingressgateway
    istio: ingressgateway
  # -- See `kubectl cluster-info` and then resolve to IP
  controlPlaneCidr: 0.0.0.0/0

upgradeJob:
  image:
    # -- image repository for upgradeJob
    repository: registry1.dso.mil/ironbank/big-bang/base
    # -- image tag for upgradeJob
    tag: 8.4

# -- Openshift Container Platform Feature Toggle
openshift: false

bbtests:
  enabled: false
  cypress:
    artifacts: true
    envs:
      cypress_expect_logs: "false"
      cypress_kibana_url: "https://logging-ek-kb-http:5601/login"
    secretEnvs:
      - name: cypress_elastic_password
        valueFrom:
          secretKeyRef:
            name: "logging-ek-es-elastic-user"
            key: elastic
  scripts:
    image: registry1.dso.mil/ironbank/stedolan/jq:1.6
    envs:
      elasticsearch_host: "https://{{ .Release.Name }}-es-http.{{ .Release.Namespace }}.svc.cluster.local:9200"
      desired_version: "{{ .Values.elasticsearch.version }}"
    secretEnvs:
      - name: ELASTIC_PASSWORD
        valueFrom:
          secretKeyRef:
            name: "logging-ek-es-elastic-user"
            key: elastic
